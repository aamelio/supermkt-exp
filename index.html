<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supermarket Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #eeeeee;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    #defaultCanvas0 {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>

<script>
// =====================================
// Layout constants
// =====================================
const CANVAS_W = 900;
const CANVAS_H = 600;
const TOP_H = 0;    // NO HEADER ANYMORE
const BOTTOM_UI_H = 100;

function imageArea() {
  return {
    x: 0,
    y: TOP_H,
    w: width,
    h: height - TOP_H - BOTTOM_UI_H
  };
}

// =====================================
// Images
// =====================================
let IMG = {};

function preload() {
  IMG.supermarket  = loadImage("bg_supermarket.png");
  IMG.aisle_cereal = loadImage("aisle2.png");
  IMG.aisle_other  = loadImage("aisle_other.png");

  IMG.cereal       = loadImage("product_cereal.png");

  IMG.prod = [];
  IMG.prod.push(loadImage("product1.png"));
  IMG.prod.push(loadImage("product2.png"));
  IMG.prod.push(loadImage("product3.png"));
  IMG.prod.push(loadImage("product4.png"));
  IMG.prod.push(loadImage("product5.png"));

  IMG.cashier = loadImage("cashier.png");
}

// =====================================
// State
// =====================================
let state = "overview";
let currentOtherAisle = null;

const PIN = "1289";
let pinInput = "";

// =====================================
// Clickable regions
// =====================================
let aisleRegions = [];
let backArrow;
let productRects = [];
let cerealRect;
let cashierRect;
let keypadButtons = [];
let clearBtn, enterBtn;

// =====================================
// Setup
// =====================================
function setup() {
  createCanvas(CANVAS_W, CANVAS_H);
  textFont("system-ui");

  const img = imageArea();
  const colW = img.w / 3;

  aisleRegions = [
    { id: 1, x: 0,      y: img.y, w: colW,     h: img.h },
    { id: 2, x: colW,   y: img.y, w: colW,     h: img.h },
    { id: 3, x: 2*colW, y: img.y, w: colW,     h: img.h }
  ];

  // New arrow-style back button INSIDE the image area
  backArrow = { x: 20, y: img.y + 20, w: 120, h: 45 };

  cashierRect = {
    x: width*0.3,
    y: img.y + img.h*0.28,
    w: width*0.4,
    h: img.h*0.45
  };

  setupProducts();
  setupKeypad();
}

function setupProducts() {
  productRects = [];
  const img = imageArea();

  const gridW = img.w * 0.66;
  const gridH = img.h * 0.66;
  const startX = img.x + (img.w - gridW)/2;
  const startY = img.y + (img.h - gridH)/2;

  const cols = 3;
  const rows = 2;
  const boxW = gridW/cols - 20;
  const boxH = gridH/rows - 20;

  let k = 0;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      const x=startX + c*(boxW+20);
      const y=startY + r*(boxH+20);
      const rectObj={x,y,w:boxW,h:boxH};
      productRects.push(rectObj);
    }
  }

  cerealRect = productRects[2]; // center-right
}

function setupKeypad() {
  const labels=["1","2","3","4","5","6","7","8","9","0"];
  let idx=0;

  const bw=80, bh=60, gap=15;
  const startX=320, startY=TOP_H+100;

  keypadButtons=[];
  for (let r=0;r<4;r++){
    for (let c=0;c<3;c++){
      if (r===3 && c>0) break;
      keypadButtons.push({
        label:labels[idx++],
        x:startX + c*(bw+gap),
        y:startY + r*(bh+gap),
        w:bw, h:bh
      });
    }
  }

  clearBtn = { label:"Clear", x:startX, y:startY+4*(bh+gap), w:bw, h:bh };
  enterBtn = { label:"Enter", x:startX+bw+gap, y:clearBtn.y, w:bw*2+gap, h:bh };
}

// =====================================
// Draw
// =====================================
function draw() {
  background(238);

  if (state==="overview")        drawOverview();
  else if (state==="aisle_other") drawAisleOther();
  else if (state==="aisle_cereal")drawAisleCereal();
  else if (state==="cashier")    drawCashierScene();
  else if (state==="pin")        drawPinScene();
  else if (state==="success")    drawSuccess();
}

// =====================================
// Overview
// =====================================
function drawOverview() {
  const img=imageArea();
  image(IMG.supermarket, img.x, img.y, img.w, img.h);

  textAlign(CENTER,CENTER);
  textSize(16);

  aisleRegions.forEach(r=>{
    const hover=isHover(r);
    fill(hover ? "rgba(255,255,255,0.2)" : "rgba(0,0,0,0)");
    noStroke();
    rect(r.x, r.y, r.w, r.h);

    fill(0,0,0,140);
    rect(r.x+10, img.y+img.h-40, r.w-20, 30, 8);

    fill(255);
    text(`Aisle ${r.id}`, r.x+r.w/2, img.y+img.h-25);
  });

  drawBottomText("<b>Go to Aisle 2 and select the Cereal Box.</b>");
}

// =====================================
// Aisle (other)
// =====================================
function drawAisleOther() {
  const img=imageArea();
  image(IMG.aisle_other, img.x, img.y, img.w, img.h);

  drawBackArrow();

  drawBottomText("<b>This aisle does not contain the cereal. Click Back and try another aisle.</b>");
}

// =====================================
// Aisle (cereal)
// =====================================
function drawAisleCereal() {
  const img=imageArea();
  image(IMG.aisle_cereal, img.x, img.y, img.w, img.h);

  drawBackArrow();

  textAlign(CENTER,CENTER);
  textSize(14);

  let pIndex=0;
  productRects.forEach((rectObj,i)=>{
    if (rectObj===cerealRect) {
      fill(255);
      rect(rectObj.x, rectObj.y, rectObj.w, rectObj.h, 12);
      image(
        IMG.cereal,
        rectObj.x+10,
        rectObj.y+10,
        rectObj.w-20,
        rectObj.h-45
      );
      fill(40);
      text("Cereal", rectObj.x+rectObj.w/2, rectObj.y+rectObj.h-20);
    } else {
      fill(255);
      rect(rectObj.x, rectObj.y, rectObj.w, rectObj.h, 12);
      image(
        IMG.prod[pIndex % IMG.prod.length],
        rectObj.x+10,
        rectObj.y+10,
        rectObj.w-20,
        rectObj.h-20
      );
      pIndex++;
    }
  });

  drawBottomText("<b>Select the Cereal Box to continue.</b>");
}

// =====================================
// Cashier Scene
// =====================================
function drawCashierScene() {
  const img=imageArea();
  image(IMG.cashier, img.x, img.y, img.w, img.h);

  drawBackArrow();

  const hover=isHover(cashierRect);
  noFill();
  stroke(hover ? color(255,230,150) : color(220));
  strokeWeight(3);
  rect(cashierRect.x, cashierRect.y, cashierRect.w, cashierRect.h, 16);

  drawBottomText("<b>Click on the cashier to pay.</b>");
}

// =====================================
// PIN screen
// =====================================
function drawPinScene() {
  noStroke();
  fill(245);
  rect(260, TOP_H+40, 380, 60, 10);

  fill(40);
  textSize(18);
  textAlign(LEFT,CENTER);
  text("Enter PIN:", 280, TOP_H+70);

  const masked="•".repeat(pinInput.length);
  textAlign(RIGHT,CENTER);
  text(masked, 620, TOP_H+70);

  textAlign(CENTER,CENTER);
  textSize(18);

  keypadButtons.forEach(btn=>{
    const hover=isHover(btn);
    stroke(hover?80:180);
    strokeWeight(1);
    fill(hover?240:252);
    rect(btn.x, btn.y, btn.w, btn.h, 10);
    noStroke();
    fill(40);
    text(btn.label, btn.x+btn.w/2, btn.y+btn.h/2);
  });

  const hc=isHover(clearBtn);
  stroke(hc?80:180);
  fill(hc?240:252);
  rect(clearBtn.x, clearBtn.y, clearBtn.w, clearBtn.h, 10);
  noStroke();
  fill(40);
  text("Clear", clearBtn.x+clearBtn.w/2, clearBtn.y+clearBtn.h/2);

  const he=isHover(enterBtn);
  stroke(he?80:180);
  fill(he?235:248);
  rect(enterBtn.x, enterBtn.y, enterBtn.w, enterBtn.h, 10);
  noStroke();
  fill(40);
  text("Enter", enterBtn.x+enterBtn.w/2, enterBtn.y+enterBtn.h/2);

  drawBottomText("<b>Enter PIN 1289 and press Enter.</b>");
}

// =====================================
// Success
// =====================================
function drawSuccess() {
  fill(255);
  rect(170, TOP_H+80, width-340, 260, 20);

  fill(40,130,80);
  textAlign(CENTER,CENTER);
  textSize(28);
  text("Payment Accepted", width/2, TOP_H+150);

  fill(50);
  textSize(18);
  text(
    "You have completed the task.\n\nClick “Next” below to continue.",
    width/2,
    TOP_H+220
  );
}

// =====================================
// Helpers
// =====================================
function drawBackArrow() {
  const hover=isHover(backArrow);

  fill(0,0,0,120);
  rect(backArrow.x, backArrow.y, backArrow.w, backArrow.h, 12);

  fill(255);
  textAlign(LEFT,CENTER);
  textSize(22);
  text("← Back", backArrow.x + 10, backArrow.y + backArrow.h/2);
}

function drawBottomText(msg){
  noStroke();
  fill(250);
  rect(0, height-BOTTOM_UI_H, width, BOTTOM_UI_H);
  fill(40);
  textAlign(LEFT,TOP);
  textSize(16);
  text(msg, 24, height-BOTTOM_UI_H+20, width-48, BOTTOM_UI_H-30);
}

function isHover(r){
  return mouseX>=r.x && mouseX<=r.x+r.w &&
         mouseY>=r.y && mouseY<=r.y+r.h;
}

// =====================================
// Mouse Interaction
// =====================================
function mousePressed() {
  if (state==="overview") {
    for (const r of aisleRegions) {
      if (isHover(r)) {
        state = r.id===2 ? "aisle_cereal" : "aisle_other";
        return;
      }
    }
  }

  if (state==="aisle_other") {
    if (isHover(backArrow)) { state="overview"; return; }
  }

  if (state==="aisle_cereal") {
    if (isHover(backArrow)) { state="overview"; return; }

    // all products clickable
    for (const rectObj of productRects){
      if (isHover(rectObj)){
        if (rectObj===cerealRect) state="cashier";
        return;
      }
    }
  }

  if (state==="cashier") {
    if (isHover(backArrow)) { state="aisle_cereal"; return; }
    if (isHover(cashierRect)) { state="pin"; return; }
  }

  if (state==="pin") {
    for (const b of keypadButtons){
      if (isHover(b)){
        if (pinInput.length<6) pinInput+=b.label;
        return;
      }
    }
    if (isHover(clearBtn)) { pinInput=""; return; }
    if (isHover(enterBtn)) {
      if (pinInput===PIN) state="success";
      else pinInput="";
      return;
    }
  }
}

</script>

</body>
</html>
