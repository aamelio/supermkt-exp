<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supermarket Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #eeeeee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    #defaultCanvas0 {
      display: block;
      margin: 0 auto;
      outline: none;
    }
  </style>
</head>
<body>
<script>
  // ---------- IMAGES (LOCAL FILES) ----------
  let IMG = {};

  function preload() {
    // All of these should be in the same folder as index.html
    IMG.supermarket = loadImage("bg_supermarket.png");
    IMG.aisle2      = loadImage("aisle2.png");
    IMG.cereal      = loadImage("product_cereal.png");
    IMG.cashier     = loadImage("cashier.png");
  }

  // ---------- STATE ----------
  // overview -> aisle -> cashier -> pin -> success
  let state = "overview";
  const correctPin = "1289";
  let pinInput = "";

  // Buttons / clickable regions
  let aisleButtons = [];
  let backButton;
  let cerealBoxRect;
  let cashierClickRect;
  let keypadButtons = [];
  let clearBtn, enterBtn;

  function setup() {
    createCanvas(900, 600);
    textFont("system-ui");

    // Aisle selection buttons (at bottom of overview)
    aisleButtons = [
      { id: 1, label: "Aisle 1", x: 120, y: 460, w: 160, h: 60 },
      { id: 2, label: "Aisle 2", x: 370, y: 460, w: 160, h: 60 }, // target
      { id: 3, label: "Aisle 3", x: 620, y: 460, w: 160, h: 60 }
    ];

    // Back button used in aisle & cashier screens
    backButton = { x: 40, y: 530, w: 130, h: 40 };

    // Cereal box clickable area in aisle screen
    cerealBoxRect = { x: 350, y: 240, w: 200, h: 220 };

    // Cashier clickable area in cashier screen
    cashierClickRect = { x: 280, y: 220, w: 340, h: 220 };

    // PIN keypad
    const labels = ["1","2","3","4","5","6","7","8","9","0"];
    let idx = 0;
    const startX = 320;
    const startY = 240;
    const bw = 80;
    const bh = 60;
    const gap = 15;

    keypadButtons = [];
    for (let row = 0; row < 4; row++) {
      for (let col = 0; col < 3; col++) {
        if (row === 3 && col > 0) break; // only "0" in last row
        keypadButtons.push({
          label: labels[idx++],
          x: startX + col * (bw + gap),
          y: startY + row * (bh + gap),
          w: bw,
          h: bh
        });
      }
    }

    clearBtn = {
      label: "Clear",
      x: 320,
      y: startY + 4 * (bh + gap),
      w: bw,
      h: bh
    };
    enterBtn = {
      label: "Enter",
      x: 320 + bw + gap,
      y: clearBtn.y,
      w: bw * 2 + gap,
      h: bh
    };
  }

  function draw() {
    background(238);

    drawHeader();

    if (state === "overview") {
      drawOverview();
    } else if (state === "aisle") {
      drawAisle();
    } else if (state === "cashier") {
      drawCashier();
    } else if (state === "pin") {
      drawPin();
    } else if (state === "success") {
      drawSuccess();
    }
  }

  function drawHeader() {
    noStroke();
    fill(30);
    rect(0, 0, width, 70);
    fill(255);
    textAlign(LEFT, CENTER);
    textSize(22);
    text("Supermarket Experience", 24, 35);
  }

  // ---------- OVERVIEW SCREEN ----------
  function drawOverview() {
    // Background supermarket
    image(IMG.supermarket, 0, 70, width, 340);

    // Instructions
    fill(40);
    textSize(18);
    textAlign(LEFT, TOP);
    text(
      "Go to Aisle 2 and select the Cereal Box.",
      24,
      430,
      width - 48,
      40
    );

    // Aisle buttons
    textSize(16);
    textAlign(CENTER, CENTER);
    aisleButtons.forEach(btn => {
      const hover = isHover(btn);
      noStroke();
      fill(hover ? 235 : 250);
      rect(btn.x, btn.y, btn.w, btn.h, 12);
      fill(40);
      text(btn.label, btn.x + btn.w / 2, btn.y + btn.h / 2);
    });
  }

  // ---------- AISLE SCREEN ----------
  function drawAisle() {
    // Aisle background
    image(IMG.aisle2, 0, 70, width, 360);

    // Back button
    drawBackButton();

    // Instruction
    fill(40);
    textSize(18);
    textAlign(LEFT, TOP);
    text(
      "Click on the Cereal Box in Aisle 2.",
      24,
      450,
      width - 48,
      40
    );

    // Cereal product (clickable)
    const hover = isHover(cerealBoxRect);
    const borderCol = hover ? 255 : 230;
    stroke(borderCol);
    strokeWeight(3);
    fill(255);
    rect(
      cerealBoxRect.x,
      cerealBoxRect.y,
      cerealBoxRect.w,
      cerealBoxRect.h,
      16
    );
    noStroke();
    image(
      IMG.cereal,
      cerealBoxRect.x + 10,
      cerealBoxRect.y + 10,
      cerealBoxRect.w - 20,
      cerealBoxRect.h - 60
    );
    fill(40);
    textAlign(CENTER, TOP);
    textSize(16);
    text(
      "Cereal Box",
      cerealBoxRect.x + cerealBoxRect.w / 2,
      cerealBoxRect.y + cerealBoxRect.h - 35
    );
  }

  // ---------- CASHIER SCREEN ----------
  function drawCashier() {
    image(IMG.cashier, 0, 70, width, 360);

    drawBackButton();

    fill(40);
    textSize(18);
    textAlign(LEFT, TOP);
    text("Click on the cashier to pay.", 24, 450, width - 48, 40);

    // (Optional) light highlight over clickable area
    const hover = isHover(cashierClickRect);
    noFill();
    stroke(hover ? color(255, 230, 150) : color(230, 230, 230));
    strokeWeight(3);
    rect(
      cashierClickRect.x,
      cashierClickRect.y,
      cashierClickRect.w,
      cashierClickRect.h,
      16
    );
  }

  // ---------- PIN SCREEN ----------
  function drawPin() {
    // PIN display
    noStroke();
    fill(245);
    rect(260, 130, 380, 60, 10);

    fill(40);
    textAlign(LEFT, CENTER);
    textSize(18);
    text("Enter PIN:", 280, 160);

    const masked = "•".repeat(pinInput.length);
    textAlign(RIGHT, CENTER);
    text(masked, 620, 160);

    // Keypad
    textAlign(CENTER, CENTER);
    textSize(18);

    keypadButtons.forEach(btn => {
      const hover = isHover(btn);
      stroke(hover ? 80 : 180);
      strokeWeight(1);
      fill(hover ? 240 : 252);
      rect(btn.x, btn.y, btn.w, btn.h, 10);
      noStroke();
      fill(40);
      text(btn.label, btn.x + btn.w / 2, btn.y + btn.h / 2);
    });

    // Clear button
    const hoverClear = isHover(clearBtn);
    stroke(hoverClear ? 80 : 180);
    strokeWeight(1);
    fill(hoverClear ? 240 : 252);
    rect(clearBtn.x, clearBtn.y, clearBtn.w, clearBtn.h, 10);
    noStroke();
    fill(40);
    textSize(16);
    text(clearBtn.label, clearBtn.x + clearBtn.w / 2, clearBtn.y + clearBtn.h / 2);

    // Enter button
    const hoverEnter = isHover(enterBtn);
    stroke(hoverEnter ? 80 : 180);
    strokeWeight(1);
    fill(hoverEnter ? 235 : 248);
    rect(enterBtn.x, enterBtn.y, enterBtn.w, enterBtn.h, 10);
    noStroke();
    fill(40);
    textSize(16);
    text(enterBtn.label, enterBtn.x + enterBtn.w / 2, enterBtn.y + enterBtn.h / 2);

    // Helper text
    noStroke();
    fill(80);
    textSize(14);
    textAlign(CENTER, TOP);
    text(
      "Use the keypad to enter PIN 1289 and then press Enter.",
      width / 2,
      520
    );
  }

  // ---------- SUCCESS SCREEN ----------
  function drawSuccess() {
    noStroke();
    fill(255);
    rect(170, 160, width - 340, 260, 20);

    fill(40, 130, 80);
    textAlign(CENTER, CENTER);
    textSize(28);
    text("Payment Accepted", width / 2, 220);

    fill(50);
    textSize(18);
    text(
      "You have completed the supermarket task.\n\nPlease click “Next” below to continue with the survey.",
      width / 2,
      300
    );
  }

  // ---------- HELPERS ----------
  function drawBackButton() {
    const hover = isHover(backButton);
    noStroke();
    fill(hover ? 220 : 235);
    rect(backButton.x, backButton.y, backButton.w, backButton.h, 10);
    fill(40);
    textAlign(CENTER, CENTER);
    textSize(14);
    text("Back", backButton.x + backButton.w / 2, backButton.y + backButton.h / 2);
  }

  function isHover(r) {
    return (
      mouseX >= r.x &&
      mouseX <= r.x + r.w &&
      mouseY >= r.y &&
      mouseY <= r.y + r.h
    );
  }

  // ---------- MOUSE INTERACTION ----------
  function mousePressed() {
    if (state === "overview") {
      aisleButtons.forEach(btn => {
        if (isHover(btn)) {
          if (btn.id === 2) {
            // Only Aisle 2 leads to the cereal
            state = "aisle";
          }
        }
      });
    } else if (state === "aisle") {
      if (isHover(backButton)) {
        state = "overview";
        return;
      }
      if (isHover(cerealBoxRect)) {
        state = "cashier";
        return;
      }
    } else if (state === "cashier") {
      if (isHover(backButton)) {
        state = "aisle";
        return;
      }
      if (isHover(cashierClickRect)) {
        state = "pin";
        return;
      }
    } else if (state === "pin") {
      // Keypad
      for (const btn of keypadButtons) {
        if (isHover(btn)) {
          if (pinInput.length < 6) {
            pinInput += btn.label;
          }
          return;
        }
      }
      // Clear
      if (isHover(clearBtn)) {
        pinInput = "";
        return;
      }
      // Enter
      if (isHover(enterBtn)) {
        if (pinInput === correctPin) {
          state = "success";
        } else {
          pinInput = "";
        }
        return;
      }
    }
  }
</script>
</body>
</html>
